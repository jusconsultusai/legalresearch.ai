# Caddy reverse proxy for JusConsultus AI
# Automatic HTTPS via Let's Encrypt for jusconsultus.online
{
	email admin@jusconsultus.online
}

jusconsultus.online {
	# ── ONLYOFFICE Document Server proxy ──────────────────────────────────────
	# The browser cannot reach localhost:8000 directly; proxy through the domain.
	route /onlyoffice/* {
		# Strip the /onlyoffice prefix before forwarding to the container
		uri strip_prefix /onlyoffice
		reverse_proxy localhost:8000 {
			# Rewrite the Location header on redirects from ONLYOFFICE
			header_up Host localhost:8000
		}
		# Allow ONLYOFFICE frames from the same origin; don't override its own headers
		header -X-Frame-Options
	}

	# Reverse proxy to Next.js production server
	reverse_proxy localhost:3000

	# Encode responses with gzip/zstd
	encode gzip zstd

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		# Remove server header
		-Server
	}

	# Logging
	log {
		output file D:/JusConsultus.AI/logs/caddy-access.log {
			roll_size 50mb
			roll_keep 3
		}
	}
}

# Redirect www to apex
www.jusconsultus.online {
	redir https://jusconsultus.online{uri} permanent
}

# DuckDNS subdomain (secondary)
jusconsultusai.duckdns.org {
	reverse_proxy localhost:3000
	encode gzip zstd
}
